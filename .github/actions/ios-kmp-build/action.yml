name: iOS KMP Build
description: Builds iOS app (optionally with KMP framework) and uploads to TestFlight

inputs:
  # Required
  match_password:
    description: "Password for decrypting of certificates and provisioning profiles."
    required: true
  app_store_connect_api_key_key:
    description: "Private App Store Connect API key for submitting build to App Store."
    required: true
  app_store_connect_api_key_key_id:
    required: true
    description: "Private App Store Connect API key for submitting build to App Store."
  app_store_connect_api_key_issuer_id:
    required: true
    description: "Private App Store Connect API issuer key for submitting build to App Store."
  # Optional
  secret_xcconfig_path:
    description: "Path to the .xcconfig file. Selected secret properties will be appended to the end of this file."
    required: false
  secret_properties:
    required: false
    description: "Secrets in the format KEY = VALUE (one per line)."
  secret_required_keys:
    description: "Comma-separated list of required secret keys."
    required: false
  kmp_swift_package_integration:
    description: "Whether KMP is integrated in Xcode project as a Swift Package"
    required: false
  kmp_swift_package_path:
    description: "If `kmp_swift_package_integration` is 'true', then specifies a location of local Swift Package with Makefile. Example: 'iosApp/shared/KMP`"
    required: false
  kmp_swift_package_flavor:
    description: "If `kmp_swift_package_integration`, specifies build flavor of KMP Package"
    required: false
  custom_values:
    description: "Custom string that can contains values specified in your workflow file. Those values will be placed into environment variable. Example: \"CUSTOM-1: 1; CUSTOM-2: 2\""
    required: false
  testflight_changelog:
    required: false
    description: "Will be used as TestFlight changelog"
  ios_custom_build_path:
    description: "Path to a folder where the iOS code is located and where bundle exec fastlane is executed. This should be relative to iosApp folder"  
    required: false
runs:
  using: "composite"
  steps:
    - name: Export secrets to .xcconfig file
      if: ${{ inputs.secret_xcconfig_path != '' }}
      uses: futuredapp/.github/.github/actions/ios-export-secrets@main
      with:
        XCCONFIG_PATH: ${{ inputs.secret_xcconfig_path }}
        SECRET_PROPERTIES: ${{ inputs.secret_properties }}
        REQUIRED_KEYS: ${{ inputs.secret_required_keys }}
    - name: Build KMP Package
      if: ${{ inputs.kmp_swift_package_integration == 'true' }}
      env:
        KMP_BUILD_FLAVOR: ${{ inputs.kmp_swift_package_flavor }}
        KMP_FRAMEWORK_BUILD_TYPE: release
      shell: bash
      run: |
        cd ${{ inputs.kmp_swift_package_path }}
        make build
    - name: Fastlane Beta
      uses: futuredapp/.github/.github/actions/ios-fastlane-beta@main
      with:
        match_password: ${{ inputs.match_password }}
        testflight_changelog: ${{ inputs.testflight_changelog }}
        app_store_connect_api_key_key: ${{ inputs.app_store_connect_api_key_key }}
        app_store_connect_api_key_key_id: ${{ inputs.app_store_connect_api_key_key_id }}
        app_store_connect_api_key_issuer_id: ${{ inputs.app_store_connect_api_key_issuer_id }}
        custom_values: ${{ inputs.custom_values }}
        custom_build_path: ${{ inputs.ios_custom_build_path && format('iosApp/{0}', inputs.ios_custom_build_path) || 'iosApp' }}
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: Build.ipa
        path: ./**/build_output/*.ipa
        if-no-files-found: error
    - name: Upload dSYM
      uses: actions/upload-artifact@v4
      with:
        name: Build.app.dSYM.zip
        path: ./**/build_output/*.app.dSYM.zip
