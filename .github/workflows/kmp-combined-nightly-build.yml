name: KMP nightly build

on:
  workflow_call:
    inputs:
      ## Required Inputs
      android_test_gradle_task:
        description: "A Gradle task(s) for executing unit tests, for example `testReleaseUnitTest` or `testDevEnterpriseUnitTest`"
        required: true
        type: string
      android_package_gradle_task:
        description: "A Gradle task for packaging universal APK, eg. 'packageEnterpriseUniversalApk'"
        required: true
        type: string
      android_upload_gradle_task:
        description: "A Gradle task for uploading APK, for example `appDistributionUploadEnterprise`"
        required: true
        type: string
      kmp_flavor:
        description: "KMP Build flavor. This is optional and only required by KMP projects and can be ignored on pure Android projects"
        required: true
        type: string
      firebase_app_distribution_groups:
        description: "Comma-separated list of app distribution group IDs"
        required: true
        type: string

      ## Optional Inputs
      timeout_minutes:
        description: "Job timeout in minutes"
        required: false
        type: number
        default: 30
      use_git_lfs:
        description: "Whether to download Git-LFS files"
        type: boolean
        required: false
        default: false
      gradle_opts:
        description: "Gradle options"
        required: false
        type: string
        default: ""
      java_version:
        description: "Java version to use"
        required: false
        type: string
        default: '17'
      java_distribution:
        description: "Java distribution to use"
        required: false
        type: string
        default: 'zulu'
      android_version_name:
        description: "Version name. Example: '1.X.X-snapshot'"
        required: false
        type: string
      android_build_number_offset:
        description: "Build number offset. This number will be added to GITHUB_RUN_NUMBER and can be used to make corrections to build numbers."
        required: false
        type: number
        default: 0
      kmp_swift_package_integration:
        description: "Whether KMP is integrated in Xcode project as a Swift Package"
        required: false
        type: boolean
        default: false
      kmp_swift_package_path:
        description: "If `kmp_swift_package_integration` is 'true', then specifies a location of local Swift Package with Makefile. Example: 'iosApp/shared/KMP`"
        required: false
        type: string
      android_secret_properties_file:
        description: "A path to file that will be populated with contents of 'android_secret_properties' secret. This file can be picked up by Secrets Gradle plugin to embed secrets into BuildConfig."
        required: false
        type: string
        default: secrets.properties
      ios_secret_xcconfig_path:
        description: "Path to the .xcconfig file. Selected secret properties will be appended to the end of this file."
        type: string
        required: false
      ios_secret_required_keys:
        description: "Comma-separated list of required secret keys."
        type: string
        required: false
      ios_custom_values:
        description: "Custom string that can contains values specified in your workflow file. Those values will be placed into environment variable. Example: \"CUSTOM-1: 1; CUSTOM-2: 2\""
        required: false
        type: string
      changelog_debug:
        description: "Enable debug mode for changelog generation. Default is false."
        type: boolean
        required: false
        default: false
      changelog_checkout_depth:
        description: "The depth of the git history to fetch for changelog generation. Default is 100."
        type: number
        required: false
        default: 100
      changelog_fallback_lookback:
        description: "The amount of time to look back for merge commits when no previous build commit is found. Default is 24 hours."
        type: string
        required: false
        default: "24 hours"

    secrets:
      firebase_app_distribution_service_account:
        required: true
        description: "JSON key of service account with permissions to upload build to Firebase App Distribution"
      gradle_cache_encryption_key:
        required: false
        description: "Configuration cache encryption key"
      android_secret_properties:
        required: false
        description: "Custom string that contains key-value properties as secrets. Contents of this secret will be placed into file specified by 'android_secret_properties_file' input."
      ios_secret_properties:
        required: false
        description: "Secrets in the format KEY = VALUE (one per line)."
      ios_match_password:
        description: "Password for decrypting of certificates and provisioning profiles."
        required: true
      ios_app_store_connect_api_key_key:
        description: "Private App Store Connect API key for submitting build to App Store."
        required: true
      ios_app_store_connect_api_key_key_id:
        required: true
        description: "Private App Store Connect API key for submitting build to App Store."
      ios_app_store_connect_api_key_issuer_id:
        required: true
        description: "Private App Store Connect API issuer key for submitting build to App Store."

jobs:
  changelog:
    outputs:
      skip_build: ${{ steps.detect_changes.outputs.skip_build }}
      changelog: ${{ steps.detect_changes.outputs.changelog }}
      cache_key: ${{ steps.detect_changes.outputs.cache_key }}
    name: Detect changes and generate changelog
    runs-on: ubuntu-latest
    steps:
      - name: Detect changes and generate changelog
        id: detect_changes
        uses: futuredapp/.github/.github/actions/universal-detect-changes-and-generate-changelog@main
        with:
          checkout_depth: ${{ inputs.changelog_checkout_depth }}
          debug: ${{ inputs.changelog_debug }}
          fallback_lookback: ${{ inputs.changelog_fallback_lookback }}
  ios_build:
    name: iOS Build
    runs-on: self-hosted
    needs: changelog
    if: ${{ needs.changelog.outputs.skip_build != 'true' }}
    timeout-minutes: ${{ inputs.timeout_minutes }}
    env:
      GRADLE_OPTS: ${{ inputs.gradle_opts }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: ${{ inputs.use_git_lfs }}
      - name: Set up environment
        uses: futuredapp/.github/.github/actions/android-setup-environment@main
        with:
          java_version: ${{ inputs.java_version }}
          java_distribution: ${{ inputs.java_distribution }}
          gradle_cache_encryption_key: ${{ secrets.gradle_cache_encryption_key }}
          ruby: 'false'
      - name: Build and upload to TestFlight
        uses: futuredapp/.github/.github/actions/ios-kmp-build@main
        with:
          match_password: ${{ secrets.ios_match_password }}
          app_store_connect_api_key_key: ${{ secrets.ios_app_store_connect_api_key_key }}
          app_store_connect_api_key_key_id: ${{ secrets.ios_app_store_connect_api_key_key_id }}
          app_store_connect_api_key_issuer_id: ${{ secrets.ios_app_store_connect_api_key_issuer_id }}
          secret_xcconfig_path: ${{ inputs.ios_secret_xcconfig_path }}
          secret_properties: ${{ secrets.ios_secret_properties }}
          secret_required_keys: ${{ inputs.ios_secret_required_keys }}
          kmp_swift_package_integration: ${{ inputs.kmp_swift_package_integration }}
          kmp_swift_package_path: ${{ inputs.kmp_swift_package_path }}
          kmp_swift_package_flavor: ${{ inputs.kmp_flavor }}
          custom_values: ${{ inputs.ios_custom_values }}
          testflight_changelog: ${{ needs.changelog.outputs.changelog }}
  android_build:
    name: Android Build
    runs-on: ubuntu-latest
    needs: changelog
    if: ${{ needs.changelog.outputs.skip_build != 'true' }}
    timeout-minutes: ${{ inputs.timeout_minutes }}
    env:
      GRADLE_OPTS: ${{ inputs.gradle_opts }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: ${{ inputs.use_git_lfs }}
      - name: Set up environment
        uses: futuredapp/.github/.github/actions/android-setup-environment@main
        with:
          java_version: ${{ inputs.java_version }}
          java_distribution: ${{ inputs.java_distribution }}
          gradle_cache_encryption_key: ${{ secrets.gradle_cache_encryption_key }}
      - name: Build and upload to App Distribution
        uses: futuredapp/.github/.github/actions/android-build-firebase@main
        with:
          test_gradle_task: ${{ inputs.android_test_gradle_task }}
          package_gradle_task: ${{ inputs.android_package_gradle_task }}
          upload_gradle_task: ${{ inputs.android_upload_gradle_task }}
          app_distribution_groups: ${{ inputs.firebase_app_distribution_groups }}
          app_distribution_service_account: ${{ secrets.firebase_app_distribution_service_account }}
          version_name: ${{ inputs.android_version_name }}
          build_number_offset: ${{ inputs.android_build_number_offset }}
          release_notes: ${{ needs.changelog.outputs.changelog }}
          kmp_flavor: ${{ inputs.kmp_flavor }}
          secret_properties_file: ${{ inputs.android_secret_properties_file }}
          secret_properties: ${{ secrets.android_secret_properties }}
  save_cache:
    name: Cache last build commit SHA
    runs-on: ubuntu-latest
    needs:
      - ios_build
      - android_build
      - changelog
    steps:
      - name: Save latest build commit SHA to file
        if: success() && needs.changelog.outputs.skip_build != 'true'
        shell: bash
        run: |
          echo "${{ github.sha }}" > latest_builded_commit.txt
          if [ "${{ inputs.changelog_debug }}" == 'true' ]; then
              echo "[DEBUG] Saved commit SHA ${{ github.sha }} to latest_builded_commit.txt"
          fi
      - name: Store latest build commit SHA in cache
        if: success() && needs.changelog.outputs.skip_build != 'true'
        uses: actions/cache/save@v4
        with:
          path: latest_builded_commit.txt
          key: ${{ needs.changelog.outputs.cache_key }}

